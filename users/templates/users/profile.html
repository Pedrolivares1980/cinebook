{% extends "blog/base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-5">
  <div class="row g-3">
    <!-- Profile Information -->
    <div class="col-12 col-lg-3">
      <div class="card">
        <img class=" rounded-circle mx-auto my-2 d-block profile-image " src="{{ user.profile.image.url }}">
        <div class="card-body">
          <h5 class="card-title">{{ user.username }}</h5>
          <p class="card-text">{{ user.email }}</p>
          <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <fieldset class="form-group">
              <legend class="border-bottom mb-4">Profile Info</legend>
              {{ u_form|crispy }}
              {{ p_form|crispy }}
            </fieldset>
            <div class="form-group">
              <button class="btn btn-outline-info" type="submit">Update</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Current Bookings -->
    <div class="col-12 col-lg-6">
      <h4 class="text-center">Current Bookings</h4>
      <div class="accordion" id="currentBookingsAccordion">
        {% for booking in current_bookings %}
        <div class="accordion-item">
          <h2 class="accordion-header" id="heading{{ booking.id }}">
            <button class="accordion-button custom-accordion-button" type="button" data-bs-toggle="collapse"
            data-bs-target="#collapse{{ booking.id }}" aria-expanded="true" aria-controls="collapse{{ booking.id }}">
              <div class="image-container d-flex justify-content-center align-items-center">
                <img src="{{ booking.showtime.movie.poster_path }}" alt="{{ booking.showtime.movie.title }} poster" class="img-fluid custom-poster">
              </div>
            </button>
          </h2>
          <div id="collapse{{ booking.id }}" class="accordion-collapse collapse"
            aria-labelledby="heading{{ booking.id }}" data-bs-parent="#currentBookingsAccordion">
            <div class="accordion-body">
              <p>Cinema: {{ booking.showtime.screening_room.cinema.name }}</p>
              <p>Screening Room: {{ booking.showtime.screening_room.name }}</p>
              <p>Movie: {{ booking.showtime.movie.title }}</p>
              <p>Date and Time: {{ booking.showtime.showtime|date:"d-m-Y H:i" }}</p>
              <p>Seats: {% for seat_reservation in booking.seat_reservations.all %}{{ seat_reservation.seat.row_letter }}{{ seat_reservation.seat.seat_number }}{% if not forloop.last %}, {% endif %}{% endfor %}</p>
              <a href="{% url 'delete_booking' booking.id %}" class="btn btn-danger btn-sm">Cancel</a>
            </div>
          </div>
        </div>
        {% empty %}
        <p>No Current Bookings.</p>
        {% endfor %}
        <!-- Pagination Controls -->
        <nav aria-label="Page navigation for current bookings">
          <ul class="pagination justify-content-center">
            <!-- Check if there are previous pages and display the First and Previous page links -->
            {% if current_bookings.has_previous %}
            <li class="page-item m-1">
              <!-- Link to the first page -->
              <a href="?current_page=1" class="btn btn-primary">&laquo; First</a>
            </li>
            <li class="page-item m-1">
              <!-- Link to the previous page -->
              <a href="?current_page={{ current_bookings.previous_page_number }}" class="btn btn-primary">Previous</a>
            </li>
            {% endif %}

            <!-- Display the current page number and the total number of pages -->
            <li class="page-item disabled m-1">
              <span class="btn btn-primary">Page {{ current_bookings.number }} of {{ current_bookings.paginator.num_pages }}</span>
            </li>

            <!-- Check if there are next pages and display the Next and Last page links -->
            {% if current_bookings.has_next %}
            <li class="page-item m-1">
              <!-- Link to the next page -->
              <a href="?current_page={{ current_bookings.next_page_number }}" class="btn btn-primary">Next</a>
            </li>
            <li class="page-item m-1">
              <!-- Link to the last page -->
              <a href="?current_page={{ current_bookings.paginator.num_pages }}" class="btn btn-primary">Last &raquo;</a>
            </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>

    <!-- Past Bookings -->
    <div class="col-12 col-lg-3">
      <h4 class="text-center">Past Bookings</h4>
      <div class="accordion" id="pastBookingsAccordion">
        {% for booking in past_bookings %}
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingPast{{ booking.id }}">
            <button class="accordion-button custom-accordion-button" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapsePast{{ booking.id }}" aria-expanded="true"
              aria-controls="collapsePast{{ booking.id }}">
                <div class="image-container d-flex justify-content-center align-items-center">
                  <img src="{{ booking.showtime.movie.poster_path }}" alt="{{ booking.showtime.movie.title }} poster" class="img-fluid custom-poster">
                </div>
            </button>
          </h2>
          <div id="collapsePast{{ booking.id }}" class="accordion-collapse collapse"
            aria-labelledby="headingPast{{ booking.id }}" data-bs-parent="#pastBookingsAccordion">
            <div class="accordion-body">
              <p>Cinema: {{ booking.showtime.screening_room.cinema.name }}</p>
              <p>Screening Room: {{ booking.showtime.screening_room.name }}</p>
              <p>Movie: {{ booking.showtime.movie.title }}</p>
              <p>Date and Time: {{ booking.showtime.showtime|date:"d-m-Y H:i" }}</p>
              <p>Seats: {% for seat_reservation in booking.seat_reservations.all %}{{ seat_reservation.seat.row_letter }}{{ seat_reservation.seat.seat_number }}{% if not forloop.last %}, {% endif %}{% endfor %}</p>
            </div>
          </div>
        </div>
        {% empty %}
        <p>No Past Bookings.</p>
        {% endfor %}
        <!-- Pagination Controls -->
        <nav class="Pagination">
          <ul class="pagination justify-content-center">
            {% if current_bookings.has_previous %}
            <li class="page-item m-1">
              <a href="?current_page=1" class="btn btn-primary">&laquo; First</a>
            </li>
            <li class="page-item m-1">
              <a href="?current_page={{ current_bookings.previous_page_number }}" class="btn btn-primary">Previous</a>
            </li>
            {% endif %}
            <li class="page-item disabled m-1">
              <span class="btn btn-primary">Page {{ current_bookings.number }} of {{ current_bookings.paginator.num_pages }}</span>
            </li>
            {% if current_bookings.has_next %}
            <li class="page-item m-1">
              <a href="?current_page={{ current_bookings.next_page_number }}" class="btn btn-primary">Next</a>
            </li>
            <li class="page-item m-1">
              <a href="?current_page={{ current_bookings.paginator.num_pages }}" class="btn btn-primary">Last &raquo;</a>
            </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>
  </div>
</div>
{% endblock content %}